@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<dynamic>
@using DotNetNuke.Web.Mvc.Helpers

<div id="contact-form">
    <h2>Send Us A Message</h2>
    <form data-moduleid="@Dnn.ModuleContext.ModuleId" id="send-message-form">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />

        <label for="name">Name</label>
        <input type="text" id="name" name="name" required />

        <label for="subject">Subject</label>
        <select id="subject" name="subject">
            <option value="Domain Registration and Management">
                Domain Registration and Management
            </option>
            <option value="DNS Configuration">
                DNS Configuration
            </option>
            <option value="SSL Certificates">
                SSL Certificates
            </option>
            <option value="VM Performance">
                VM Performance
            </option>
            <option value="VM Connectivity">
                VM Connectivity
            </option>
            <option value="Security">
                Security
            </option>
        </select>

        <label for="message">Message</label>
        <textarea id="message" name="message" required></textarea>

        <button type="button" id="send-message">Send</button>
        <div id="svg-container">
        </div>
    </form>

    <div id="message-status"></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    // Function to send ticket data
    function sendTicket(ticketData) {
        // URL of the API endpoint
        const apiUrl = 'https://rf.uni-corvinus.hu/mantis/api/rest/issues';

        // Prepare the data payload as a JSON object
        const jsonBody = {
            summary: "[Domania_SUPPORT] - " + ticketData.subject,
            description: "Sender: " + ticketData.name + "\nEmail: " + ticketData.email + "\nMessage: " + ticketData.message,
            project: { id: 49, name: "Forró Torták" },
            category: { id: 5, name: "Design" },
            handler: { id: 146, name: "therigozsolti" },
            view_state: { id: 10, name: "public" },
            priority: { id: 30, name: "normal" },
            severity: { id: 10, name: "kérés" },
            reproducibility: { name: "nem próbáltam" }
        };

        // Make the AJAX POST request
        $.ajax({
            url: apiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(jsonBody),
            headers: {
                'Authorization': 'aS-X0G5twCHlaJjdsnq0ruiugKLl5kkY' // Replace 'YOUR_API_KEY_HERE' with your actual API key
            },
            success: function (response) {
                console.log('Ticket successfully sent:', response);
                $('#svg-container').hide();
                $('#message-status').html('<p>Sikeres küldés!</p>');
                // Handle success response
            },
            error: function (xhr, status, error) {
                console.log('Error sending ticket:', xhr.responseText);
                // Handle error
            }
        });
    }

    $(document).ready(function () {
        $('#send-message').click(function () {
            $(this).hide(); // Hide the button
            $('#svg-container').html(`
                <svg xmlns = "http://www.w3.org/2000/svg" viewBox = "0 0 100 100" preserveAspectRatio = "xMidYMid" width = "25" height = "25" style = "shape-rendering: auto; display: block; background: transparent;" xmlns: xlink = "http://www.w3.org/1999/xlink" >
                <g>
                    <circle stroke-dasharray="122.52211349000194 42.840704496667314" r="26" stroke-width="8" stroke="#49d7f7" fill="none" cy="50" cx="50">
                        <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="0.78125s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
                    </circle>
                    <g></g>
                </g>
                 </svg >
            `).show();

            var moduleID = $('#send-message-form').data('moduleid');
            var email = $('#email').val();
            var name = $('#name').val();
            var subject = $('#subject').val();
            var message = $('#message').val();

            if (!email || !name || !message) {
                $('#message-status').addClass('error').text('Please fill out all required fields.');
                return;
            }

            // Log the data to be sent
            console.log('Sending the following data:');
            console.log('Module ID:', moduleID);
            console.log('Email:', email);
            console.log('Name:', name);
            console.log('Subject:', subject);
            console.log('Message:', message);

            // Commenting out the AJAX request and just logging the data for now

            sendTicket({
                email: email,
                name: name,
                subject: subject,
                message: message
            });


        });
    });

</script>
<style>
    #message-status.success {
        color: #28a745; /* Success color */
    }

    #message-status.error {
        color: #dc3545; /* Error color */
    }
</style>
